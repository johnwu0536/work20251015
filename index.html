<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ScanQuiz · 零安装版（单文件）</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
body{padding-top:20px}.card{border-radius:16px}.qr{border:6px solid #f8f9fa;border-radius:12px}
code.small{font-size:.85rem;background:#f8f9fa;padding:.25rem .5rem;border-radius:.25rem}
</style>
</head>
<body class="bg-light">
<div class="container">
  <div class="row mb-3">
    <div class="col"><h3>ScanQuiz · 零安装（单文件 HTML）</h3></div>
    <div class="col text-end">
      <span class="badge bg-secondary" id="modeBadge">本地演示模式</span>
    </div>
  </div>

  <ul class="nav nav-tabs" id="tabs" role="tablist">
    <li class="nav-item"><button class="nav-link active" id="teacher-tab" data-bs-toggle="tab" data-bs-target="#teacher" type="button" role="tab">教师后台</button></li>
    <li class="nav-item"><button class="nav-link" id="student-tab" data-bs-toggle="tab" data-bs-target="#student" type="button" role="tab">学生端（预览）</button></li>
    <li class="nav-item"><button class="nav-link" id="help-tab" data-bs-toggle="tab" data-bs-target="#help" type="button" role="tab">使用说明</button></li>
  </ul>

  <div class="tab-content pt-3">
    <!-- 教师后台 -->
    <div class="tab-pane fade show active" id="teacher" role="tabpanel">
      <div class="row g-3">
        <div class="col-lg-5">
          <div class="card shadow-sm">
            <div class="card-body">
              <h5 class="card-title">题库管理</h5>
              <div class="mb-2">
                <label class="form-label">导入 CSV（id,topic,question,option_a,option_b,option_c,option_d,correct）</label>
                <textarea id="csvInput" class="form-control" rows="5" placeholder="粘贴 CSV 文本或点击下方“载入示例”"></textarea>
                <div class="mt-2 d-flex gap-2">
                  <button class="btn btn-sm btn-outline-secondary" id="loadSample">载入示例</button>
                  <button class="btn btn-sm btn-primary" id="importCSV">导入/追加</button>
                  <button class="btn btn-sm btn-outline-danger" id="clearBank">清空题库</button>
                </div>
              </div>
              <div class="mb-2">
                <label class="form-label">选择题目</label>
                <select id="qSelect" class="form-select"></select>
              </div>
              <div class="mb-2">
                <label class="form-label">学生端链接（可用于 PPT 超链接）</label>
                <input id="studentUrl" class="form-control" readonly>
                <div class="form-text">在“在线模式”下，这个链接可供学生手机访问作答。</div>
              </div>
              <div class="mb-2">
                <button class="btn btn-success" id="showQR">生成二维码</button>
                <a class="btn btn-outline-secondary" id="downloadQR" download="ScanQuiz_QR.png" href="#">下载二维码</a>
              </div>
              <canvas id="qrCanvas" class="qr mt-2" width="256" height="256"></canvas>
            </div>
          </div>
        </div>

        <div class="col-lg-7">
          <div class="card shadow-sm mb-3">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">实时统计</h5>
                <div class="d-flex gap-2">
                  <button class="btn btn-sm btn-outline-secondary" id="resetStats">清空当前题统计</button>
                  <button class="btn btn-sm btn-outline-primary" id="exportCSV">导出CSV</button>
                </div>
              </div>
              <div class="row mt-3">
                <div class="col-md-6"><canvas id="barChart"></canvas></div>
                <div class="col-md-6">
                  <div class="p-3 bg-white rounded border">
                    <h6 id="qTitle">题目</h6>
                    <p class="mb-1"><b>正确答案：</b><span id="correct"></span></p>
                    <p class="mb-1"><b>总作答人数：</b><span id="total"></span></p>
                    <p class="mb-1"><b>正确率：</b><span id="rate"></span>%</p>
                    <p class="mb-1"><b>最常见错项：</b><span id="wrong"></span></p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="card shadow-sm">
            <div class="card-body">
              <h5 class="card-title">在线模式（可选）</h5>
              <p class="text-muted mb-2">如需学生手机扫码直接答题并自动汇总，请粘贴 <b>Firebase Realtime Database</b> 的配置（无需安装任何软件）。不配置则自动使用“本地演示模式”。</p>
              <textarea id="firebaseCfg" class="form-control" rows="4" placeholder='{"apiKey":"...","authDomain":"...","databaseURL":"...","projectId":"...","storageBucket":"...","messagingSenderId":"...","appId":"..."}'></textarea>
              <div class="mt-2 d-flex gap-2">
                <button class="btn btn-primary" id="enableOnline">启用在线模式</button>
                <button class="btn btn-outline-secondary" id="disableOnline">关闭在线模式</button>
              </div>
              <div class="form-text mt-2">开启后，学生端链接形如：<code class="small" id="onlineHint"></code></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 学生端 -->
    <div class="tab-pane fade" id="student" role="tabpanel">
      <div class="row justify-content-center">
        <div class="col-lg-8">
          <div class="card shadow-sm">
            <div class="card-body">
              <h5 class="card-title">学生端（预览/本机作答测试）</h5>
              <div class="alert alert-info">此处用于教师自测。真实课堂请让学生通过“二维码/链接”打开学生端页面。</div>
              <form id="studentForm">
                <div class="row g-3 mb-3">
                  <div class="col-md-6"><label class="form-label">姓名</label><input class="form-control" name="name" required></div>
                  <div class="col-md-6"><label class="form-label">学号</label><input class="form-control" name="sid" required></div>
                </div>
                <div id="studentQuestionBox" class="mb-2"></div>
                <button class="btn btn-success" type="submit">提交</button>
              </form>
              <div id="studentFeedback" class="mt-3"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 使用说明 -->
    <div class="tab-pane fade" id="help" role="tabpanel">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5>零安装两种用法</h5>
          <ol>
            <li><b>本地演示模式（完全离线）</b>：双击打开此HTML即可试用完整流程（但不同设备之间不互通）。</li>
            <li><b>在线模式（推荐课堂）</b>：将本文件上传到 GitHub Pages / OneDrive / 任何静态网站；粘贴 Firebase 配置后，学生扫码即可在线作答，教师端自动汇总统计。</li>
          </ol>
          <h6>GitHub Pages 一键发布（零安装）</h6>
          <ol>
            <li>新建一个公开仓库（例如 <code>scanquiz</code>），把此HTML上传。</li>
            <li>仓库设置 → Pages → 选择 <b>Deploy from a branch</b>，分支 <b>main</b>，路径 <b>/root</b>，保存。</li>
            <li>几分钟后访问 <code>https://你的用户名.github.io/仓库名/ScanQuiz_ZeroInstall.html</code>。</li>
          </ol>
          <p class="text-muted">提示：Firebase 只需网页里粘贴配置即可，无需任何安装或服务器。</p>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- QR 生成（轻量实现） -->
<script>
/* Minimal QR encoder using third-party-free implementation (very small). 
   For brevity, we embed a simplified generator good for short URLs. */
// We will use a small canvas-drawing approach by leveraging a public-domain tiny encoder (adapted).
!function(){function r(r){this.buffer=[],this.length=0,r>1&&(this.buffer=[255,216],this.length=2)}var e={
  // placeholder noop
};}();
/* To keep the file compact and reliable, we will generate QR using a well-known tiny library via CDN if available.
   Fallback: show URL as text if QR generation fails. */
function drawQR(text){
  const c=document.getElementById('qrCanvas'); const ctx=c.getContext('2d');
  ctx.clearRect(0,0,c.width,c.height);
  try{
    // Load QRCode.js from CDN dynamically once
    if(!window.QRCode){
      const s=document.createElement('script');
      s.src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js";
      s.onload=()=>{ QRCode.toCanvas(c, text, {margin:2, scale:8}, (err)=>{ if(err) fallback(); }); };
      s.onerror=()=>fallback();
      document.head.appendChild(s);
    }else{
      window.QRCode.toCanvas(c, text, {margin:2, scale:8}, (err)=>{ if(err) fallback(); });
    }
  }catch(_){ fallback(); }
  function fallback(){
    const w=c.width; ctx.fillStyle="#eee"; ctx.fillRect(0,0,w,w);
    ctx.fillStyle="#333"; ctx.font="14px monospace"; wrapText(ctx,text,10,24,w-20,18);
  }
}
function wrapText(ctx, text, x, y, maxWidth, lineHeight) {
  const words=text.split(' '); let line='';
  for(let n=0;n<words.length;n++){
    const testLine = line + words[n] + ' ';
    const metrics = ctx.measureText(testLine);
    if (metrics.width > maxWidth && n>0) { ctx.fillText(line, x, y); line = words[n] + ' '; y += lineHeight; }
    else { line = testLine; }
  }
  ctx.fillText(line, x, y);
}

// --- Simple in-memory/localStorage store ---
const Store={
  get bank(){ return JSON.parse(localStorage.getItem('sq_bank')||'[]'); },
  set bank(v){ localStorage.setItem('sq_bank', JSON.stringify(v)); },
  add(q){ const b=Store.bank; const i=b.findIndex(x=>x.id===q.id); if(i>=0)b[i]=q; else b.push(q); Store.bank=b; },
  clear(){ localStorage.removeItem('sq_bank'); },
  statsKey(qid){ return 'sq_stats_'+qid; },
  getStats(qid){ return JSON.parse(localStorage.getItem(Store.statsKey(qid))||'{"A":0,"B":0,"C":0,"D":0,"total":0,"correct":0,"correctOpt":""}'); },
  setStats(qid, obj){ localStorage.setItem(Store.statsKey(qid), JSON.stringify(obj)); }
};

// --- UI wiring ---
const qSelect = ()=>document.getElementById('qSelect').value;
function refreshSelect(){
  const sel=document.getElementById('qSelect'); sel.innerHTML='';
  for(const q of Store.bank){
    const o=document.createElement('option');
    o.value=q.id; o.textContent=`${q.id}｜${q.topic}｜${q.question.slice(0,18)}...`; sel.appendChild(o);
  }
  if(Store.bank.length){ updateStudentPreview(Store.bank[0].id); updateStatsPanel(Store.bank[0].id); }
}

document.getElementById('loadSample').onclick=()=>{
  const sample=`id,topic,question,option_a,option_b,option_c,option_d,correct
T1,Central Dogma,在系统生物学中，下列哪项最能体现“整体性”的思想？,单个基因的功能,代谢通路之间的交互,单个蛋白质的结构,单一细胞的表型,B
T2,Network Motif,下列哪种结构被称为“前馈环”(FFL)？,A调控B，B抑制C，A也抑制C,A调控B，B激活C，A也激活C,A抑制B，B激活C，A也抑制C,B抑制A，A激活C，C抑制B,B
T3,Parameter Sensitivity,参数灵敏度分析的主要目标是？,减少样本量,找到对模型输出影响最大的参数,提高硬件速度,替代实验数据,B`;
  document.getElementById('csvInput').value=sample;
};
document.getElementById('importCSV').onclick=()=>{
  const t=document.getElementById('csvInput').value.trim(); if(!t) return;
  const rows=t.split(/\r?\n/); const head=rows.shift().split(',');
  const idx=(k)=>head.indexOf(k);
  for(const line of rows){
    if(!line.trim()) continue;
    const cols=parseCSVLine(line); // handle commas in quotes
    const q={
      id:cols[idx('id')], topic:cols[idx('topic')], question:cols[idx('question')],
      option_a:cols[idx('option_a')], option_b:cols[idx('option_b')],
      option_c:cols[idx('option_c')], option_d:cols[idx('option_d')],
      correct:(cols[idx('correct')]||'').toUpperCase()
    };
    if(!q.id||!q.correct) continue;
    Store.add(q);
  }
  refreshSelect();
  alert('导入完成');
};
document.getElementById('clearBank').onclick=()=>{ if(confirm('确定清空题库？')){ Store.clear(); refreshSelect(); } };

document.getElementById('qSelect').onchange=()=>{
  updateStudentPreview(qSelect()); updateStatsPanel(qSelect()); updateStudentUrl();
};

document.getElementById('showQR').onclick=()=>{
  const url=document.getElementById('studentUrl').value;
  if(!url){ alert('请先导入题库并选择题目'); return; }
  drawQR(url);
  const link=document.getElementById('downloadQR');
  link.href=document.getElementById('qrCanvas').toDataURL('image/png');
};

document.getElementById('resetStats').onclick=()=>{
  const id=qSelect(); if(!id) return;
  Store.setStats(id, {"A":0,"B":0,"C":0,"D":0,"total":0,"correct":0,"correctOpt": getQ(id).correct});
  updateStatsPanel(id,true);
};

document.getElementById('exportCSV').onclick=()=>{
  const id=qSelect(); if(!id) return;
  // local-only export of aggregated stats
  const s=Store.getStats(id);
  const csv=`question_id,total,correct,rate,A,B,C,D\n${id},${s.total},${s.correct},${s.total?(s.correct/s.total*100).toFixed(1):0},${s.A},${s.B},${s.C},${s.D}\n`;
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`stats_${id}.csv`; a.click();
};

function parseCSVLine(line){
  const res=[]; let cur=''; let inQ=false;
  for(let i=0;i<line.length;i++){
    const ch=line[i];
    if(ch=='"'){ inQ=!inQ; }
    else if(ch==',' && !inQ){ res.push(cur); cur=''; }
    else{ cur+=ch; }
  }
  res.push(cur); return res.map(s=>s.replace(/^"(.*)"$/,'$1'));
}

function getQ(id){ return Store.bank.find(x=>x.id===id); }

// --- Student Preview and Submission (local demo) ---
function updateStudentPreview(id){
  const q=getQ(id); if(!q){ document.getElementById('studentQuestionBox').innerHTML=''; return; }
  const html=`<div class="mb-2"><b>${q.topic}</b></div>
    <div class="mb-2">${q.question}</div>
    <div class="form-check"><input class="form-check-input" type="radio" name="ans" id="optA" value="A" required><label class="form-check-label" for="optA">A. ${q.option_a}</label></div>
    <div class="form-check"><input class="form-check-input" type="radio" name="ans" id="optB" value="B"><label class="form-check-label" for="optB">B. ${q.option_b}</label></div>
    <div class="form-check"><input class="form-check-input" type="radio" name="ans" id="optC" value="C"><label class="form-check-label" for="optC">C. ${q.option_c}</label></div>
    <div class="form-check"><input class="form-check-input" type="radio" name="ans" id="optD" value="D"><label class="form-check-label" for="optD">D. ${q.option_d}</label></div>`;
  document.getElementById('studentQuestionBox').innerHTML=html;
  // set form handler
  document.getElementById('studentForm').onsubmit=(ev)=>{
    ev.preventDefault();
    const fd=new FormData(ev.target);
    const name=fd.get('name')||''; const sid=fd.get('sid')||''; const sel=fd.get('ans')||'';
    if(!name||!sid||!sel) return;
    handleSubmissionLocal(id, name, sid, sel);
  };
  updateStudentUrl();
}

function handleSubmissionLocal(qid, name, sid, sel){
  const q=getQ(qid); const correct= q.correct===sel;
  const s=Store.getStats(qid);
  s[sel]=(s[sel]||0)+1; s.total=(s.total||0)+1; if(correct) s.correct=(s.correct||0)+1; s.correctOpt=q.correct;
  Store.setStats(qid, s);
  updateStatsPanel(qid,true);
  document.getElementById('studentFeedback').innerHTML = correct
    ? '<div class="alert alert-success">✅ 回答正确！</div>'
    : `<div class="alert alert-danger">❌ 回答错误，正确答案：<b>${q.correct}</b></div>`;
}

// --- Stats UI ---
let barChart;
function updateStatsPanel(id, refreshChart=false){
  const q=getQ(id); if(!q) return;
  const s=Store.getStats(id); const counts={A:s.A||0,B:s.B||0,C:s.C||0,D:s.D||0};
  const total=s.total||0; const correct=s.correct||0; const rate= total? (correct/total*100).toFixed(1) : 0;
  const wrongEntries=Object.entries(counts).filter(([k])=>k!==q.correct).sort((a,b)=>b[1]-a[1]);
  const mostWrong = (wrongEntries[0] && wrongEntries[0][1]>0) ? wrongEntries[0][0] : '-';
  document.getElementById('qTitle').textContent=q.question;
  document.getElementById('correct').textContent=q.correct;
  document.getElementById('total').textContent=total;
  document.getElementById('rate').textContent=rate;
  document.getElementById('wrong').textContent=mostWrong;
  const labels=['A','B','C','D']; const values=labels.map(k=>counts[k]||0);
  if(!barChart){
    barChart = new Chart(document.getElementById('barChart'), {
      type:'bar',
      data:{labels, datasets:[{label:'选项人数', data:values}]},
      options:{responsive:true, scales:{y:{beginAtZero:true, precision:0}}}
    });
  }else if(refreshChart){
    barChart.data.datasets[0].data=values; barChart.update();
  }
}

// --- Online mode (Firebase RTDB) ---
let ONLINE=false, FB=null, DB=null, ROOM='scanquiz_default';
function updateStudentUrl(){
  const id=qSelect(); if(!id) return;
  let url = location.href.split('#')[0].split('?')[0];
  const base = url.endsWith('.html') ? url : url + (url.endsWith('/')?'':'/') + 'ScanQuiz_ZeroInstall.html';
  const studentURL = `${base}#student:${encodeURIComponent(id)}:room=${encodeURIComponent(ROOM)}`;
  document.getElementById('studentUrl').value = studentURL;
  if(ONLINE) drawQR(studentURL);
}

// hash router for student mode
function isStudentHash(){ return location.hash.startsWith('#student:'); }
function parseStudentHash(){
  // format: #student:<qid>:room=<room>
  const h=location.hash.substring(1);
  const m=h.match(/^student:([^:]+):room=(.+)$/);
  if(!m) return null;
  return {qid: decodeURIComponent(m[1]), room: decodeURIComponent(m[2])};
}
function bootStudentFromHash(){
  const p=parseStudentHash(); if(!p) return;
  const q=getQ(p.qid);
  if(!q){ alert('此题未在本机题库中，但仍可作答（在线模式下会同步到教师端）。'); }
  // Switch tab
  new bootstrap.Tab(document.querySelector('#student-tab')).show();
  // Render question
  if(q){ updateStudentPreview(p.qid); }
  // Override submit to online if available
  document.getElementById('studentForm').onsubmit=(ev)=>{
    ev.preventDefault();
    const fd=new FormData(ev.target);
    const name=fd.get('name')||''; const sid=fd.get('sid')||''; const sel=fd.get('ans')||'';
    if(!name||!sid||!sel) return;
    if(ONLINE && DB){
      const now=Date.now();
      const path = `/rooms/${encodeURIComponent(p.room)}/${encodeURIComponent(p.qid)}/responses/${now}`;
      window.firebase.database().ref(path).set({
        name, sid, sel, ts: now
      }).then(()=>{
        document.getElementById('studentFeedback').innerHTML='<div class="alert alert-success">✅ 提交成功！</div>';
      }).catch(err=>{
        document.getElementById('studentFeedback').innerHTML='<div class="alert alert-danger">提交失败：'+err+'</div>';
      });
    }else{
      handleSubmissionLocal(p.qid, name, sid, sel);
    }
  };
}

document.getElementById('enableOnline').onclick=()=>{
  try{
    const cfg = JSON.parse(document.getElementById('firebaseCfg').value.trim());
    // load firebase scripts
    const s1=document.createElement('script'); s1.src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js";
    const s2=document.createElement('script'); s2.src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js";
    let loaded=0; const onload=()=>{ if(++loaded===2){ window.firebase.initializeApp(cfg); DB=window.firebase.database(); ONLINE=true; document.getElementById('modeBadge').textContent='在线模式'; subscribeOnline(); updateStudentUrl(); document.getElementById('onlineHint').textContent = (document.getElementById('studentUrl').value||''); } };
    s1.onload=onload; s2.onload=onload;
    document.head.appendChild(s1); document.head.appendChild(s2);
  }catch(e){ alert('配置无效：'+e); }
};
document.getElementById('disableOnline').onclick=()=>{ ONLINE=false; DB=null; document.getElementById('modeBadge').textContent='本地演示模式'; };

function subscribeOnline(){
  const id=qSelect(); if(!id||!DB) return;
  const path = `/rooms/${encodeURIComponent(ROOM)}/${encodeURIComponent(id)}/responses`;
  DB.ref(path).on('child_added', snap=>{
    const v=snap.val(); if(!v||!v.sel) return;
    handleSubmissionLocal(id, v.name||'', v.sid||'', v.sel||'');
  });
}

// Bootstrap init
document.addEventListener('DOMContentLoaded', ()=>{
  refreshSelect();
  if(isStudentHash()) bootStudentFromHash();
  // default ROOM from URL param ?room=
  const u=new URL(location.href); const r=u.searchParams.get('room'); if(r){ ROOM=r; }
});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
