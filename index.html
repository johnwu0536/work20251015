<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ScanQuiz Â· é¦–é¡µ</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
<style>
  body{padding:24px}
  .card{border-radius:20px}
  .qr{border:6px solid #f8f9fa;border-radius:12px}
  .muted{color:#6c757d}
</style>
</head>
<body class="bg-light">
<div class="container">
  <div class="d-flex align-items-center justify-content-between mb-4">
    <div class="d-flex align-items-center gap-3">
      <div style="font-size:36px">ğŸ§ª</div>
      <div>
        <h2 class="mb-0">ScanQuiz Â· ç³»ç»Ÿç”Ÿç‰©å­¦è¯¾å ‚äº’åŠ¨</h2>
        <div class="muted">ä¸€ä¸ªé›¶å®‰è£…ã€æ‰«ç å³ç­”çš„è¯¾å ‚å³æ—¶åé¦ˆå·¥å…·</div>
      </div>
    </div>
    <span id="statusBadge" class="badge bg-secondary">æœªæ£€æµ‹</span>
  </div>

  <div class="row g-4">
    <div class="col-lg-6">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h5 class="card-title"><i class="bi bi-cloud-check"></i> åœ¨çº¿é…ç½®ï¼ˆFirebase Realtime Databaseï¼‰</h5>
          <p class="text-muted mb-2">ç²˜è´´ <b>JSON</b>ï¼ˆåŒ…å« <code>apiKey</code>ã€<code>databaseURL</code> ç­‰ï¼‰ã€‚ç”¨äºç”Ÿæˆå¸¦é…ç½®å‚æ•°çš„å¿«æ·é“¾æ¥ä¸äºŒç»´ç ã€‚</p>
          <textarea id="cfg" class="form-control" rows="6" placeholder='{"apiKey":"...","authDomain":"...","databaseURL":"...","projectId":"...","storageBucket":"...","messagingSenderId":"...","appId":"..."}'></textarea>
          <div class="row g-2 mt-2">
            <div class="col-md-6">
              <label class="form-label">æˆ¿é—´åï¼ˆroomï¼‰</label>
              <input id="room" class="form-control" placeholder="å¦‚ï¼šSysBio_2025_10_15" value="SysBio_2025">
            </div>
            <div class="col-md-6">
              <label class="form-label">é¢˜ç›®IDï¼ˆqidï¼‰</label>
              <input id="qid" class="form-control" placeholder="å¦‚ï¼šT1" value="T1">
            </div>
          </div>
          <div class="d-flex gap-2 mt-3">
            <button id="testBtn" class="btn btn-outline-primary"><i class="bi bi-activity"></i> æ£€æµ‹è¿æ¥</button>
            <button id="buildBtn" class="btn btn-primary"><i class="bi bi-link-45deg"></i> ç”Ÿæˆé“¾æ¥ & äºŒç»´ç </button>
            <button id="clearBtn" class="btn btn-outline-secondary"><i class="bi bi-trash"></i> æ¸…ç©º</button>
          </div>
          <div class="form-text mt-2">æç¤ºï¼šè¿æ¥æˆåŠŸåï¼Œå­¦ç”Ÿç«¯æ‰å¯ä»äº‘ç«¯è¯»å–é¢˜ç›®ã€‚</div>
        </div>
      </div>
    </div>

    <div class="col-lg-6">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h5 class="card-title"><i class="bi bi-joystick"></i> å¿«é€Ÿå…¥å£</h5>
          <p class="text-muted">é“¾æ¥ä¼šå¸¦ä¸Š <code>room/qid/cfg</code> å‚æ•°ï¼Œä¾¿äºè¯¾å ‚ä½¿ç”¨ã€‚</p>
          <div class="mb-3">
            <label class="form-label">æ•™å¸ˆç«¯é“¾æ¥ï¼ˆteacher.htmlï¼‰</label>
            <input id="teacherLink" class="form-control" readonly>
          </div>
          <div class="mb-3">
            <label class="form-label">å­¦ç”Ÿç«¯é“¾æ¥ï¼ˆstudent.htmlï¼‰</label>
            <input id="studentLink" class="form-control" readonly>
          </div>

          <div class="row g-3 align-items-start">
            <div class="col-md-6 text-center">
              <div class="mb-2 muted">å­¦ç”Ÿç«¯äºŒç»´ç </div>
              <canvas id="qrStudent" class="qr" width="256" height="256"></canvas>
              <div class="mt-2">
                <a id="dlStudentQR" class="btn btn-sm btn-outline-secondary" download="ScanQuiz_Student_QR.png" href="#"><i class="bi bi-download"></i> ä¸‹è½½äºŒç»´ç </a>
              </div>
            </div>
            <div class="col-md-6 text-center">
              <div class="mb-2 muted">æ•™å¸ˆç«¯äºŒç»´ç </div>
              <canvas id="qrTeacher" class="qr" width="256" height="256"></canvas>
              <div class="mt-2">
                <a id="dlTeacherQR" class="btn btn-sm btn-outline-secondary" download="ScanQuiz_Teacher_QR.png" href="#"><i class="bi bi-download"></i> ä¸‹è½½äºŒç»´ç </a>
              </div>
            </div>
          </div>

          <hr>
          <div class="d-flex gap-2">
            <a class="btn btn-outline-dark" id="openTeacher" target="_blank"><i class="bi bi-box-arrow-up-right"></i> è¿›å…¥æ•™å¸ˆç«¯</a>
            <a class="btn btn-success" id="openStudent" target="_blank"><i class="bi bi-qr-code-scan"></i> è¿›å…¥å­¦ç”Ÿç«¯</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="card shadow-sm mt-4">
    <div class="card-body">
      <h5 class="card-title"><i class="bi bi-info-circle"></i> ä½¿ç”¨è¯´æ˜</h5>
      <ol class="mb-0">
        <li>å…ˆæ‰“å¼€ <b>æ•™å¸ˆç«¯</b>ï¼Œå¯¼å…¥é¢˜åº“å¹¶é€‰æ‹©é¢˜ç›®ï¼›åœ¨æ•™å¸ˆç«¯ç‚¹å‡»â€œè¿æ¥â€åï¼Œä¼šæŠŠå½“å‰é¢˜å‘å¸ƒåˆ°æ•°æ®åº“çš„ <code>/rooms/&lt;room&gt;/&lt;qid&gt;/question</code>ã€‚</li>
        <li>ä»æœ¬é¡µç”Ÿæˆ <b>å­¦ç”Ÿç«¯é“¾æ¥</b>ï¼ˆå« room/qid/cfgï¼‰ï¼Œæ’å…¥åˆ° PPT çš„äºŒç»´ç é‡Œç»™å­¦ç”Ÿæ‰«ç ã€‚</li>
        <li>å­¦ç”Ÿä½œç­”ä¼šå†™å…¥ <code>/rooms/&lt;room&gt;/&lt;qid&gt;/responses/&lt;timestamp&gt;</code>ï¼Œæ•™å¸ˆç«¯ä¼šå®æ—¶ç»Ÿè®¡ã€‚</li>
        <li>æ›´æ¢é¢˜åº“æˆ–åˆ‡æ¢é¢˜ç›®åï¼Œè¯·å›åˆ° <b>æ•™å¸ˆç«¯</b>é‡æ–°å‘å¸ƒé¢˜ç›®å¹¶åœ¨æœ¬é¡µ<b>é‡æ–°ç”ŸæˆäºŒç»´ç </b>ã€‚</li>
      </ol>
    </div>
  </div>
</div>

<script>
// å·¥å…·å‡½æ•°
function basePath(){
  const url = new URL(location.href);
  const parts = url.pathname.split('/');
  parts.pop(); // remove current file
  return url.origin + parts.join('/') + '/';
}
function safeB64(jsonStr){
  try{
    // ç›´æ¥ btoa å¯¹ UTF-8 ä¸å®‰å…¨ï¼Œè¿™é‡Œè¿›è¡Œç¼–ç è½¬æ¢
    return btoa(unescape(encodeURIComponent(jsonStr)));
  }catch(e){ return ''; }
}
function drawQR(canvasId, text){
  const c = document.getElementById(canvasId);
  const draw = ()=> window.QRCode.toCanvas(c, text, {margin:2, scale:8}, err=>{
    if(err){ const ctx=c.getContext('2d'); ctx.fillStyle='#eee'; ctx.fillRect(0,0,c.width,c.height); ctx.fillStyle='#333'; ctx.font='12px monospace'; ctx.fillText('æ— æ³•ç”ŸæˆQR',16,132); }
  });
  if(!window.QRCode){
    const s=document.createElement('script'); s.src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"; s.onload=draw; document.head.appendChild(s);
  }else{ draw(); }
}
function buildLinks(){
  const cfgText=document.getElementById('cfg').value.trim();
  const room=document.getElementById('room').value.trim();
  const qid=document.getElementById('qid').value.trim();
  if(!cfgText || !room || !qid){ alert('è¯·å¡«å†™ é…ç½® / æˆ¿é—´ / é¢˜ç›®ID'); return; }
  let cfgB64 = '';
  try{ cfgB64 = safeB64(cfgText); JSON.parse(cfgText); } catch(e){ alert('é…ç½®ä¸æ˜¯åˆæ³• JSONï¼š'+e); return; }
  const base = basePath();
  const teacher = `${base}teacher.html?room=${encodeURIComponent(room)}&qid=${encodeURIComponent(qid)}&cfg=${encodeURIComponent(cfgB64)}`;
  const student = `${base}student.html?room=${encodeURIComponent(room)}&qid=${encodeURIComponent(qid)}&cfg=${encodeURIComponent(cfgB64)}`;
  document.getElementById('teacherLink').value = teacher;
  document.getElementById('studentLink').value = student;
  drawQR('qrTeacher', teacher);
  drawQR('qrStudent', student);
  document.getElementById('dlTeacherQR').href = document.getElementById('qrTeacher').toDataURL('image/png');
  document.getElementById('dlStudentQR').href = document.getElementById('qrStudent').toDataURL('image/png');
  document.getElementById('openTeacher').href = teacher;
  document.getElementById('openStudent').href = student;
}

// è¿æ¥æ£€æµ‹ï¼šå°è¯•åˆå§‹åŒ– Firebaseï¼Œå¹¶è¯»å– /.info/connected
document.getElementById('testBtn').onclick=()=>{
  const cfgText=document.getElementById('cfg').value.trim();
  if(!cfgText){ alert('è¯·å…ˆç²˜è´´ Firebase JSON'); return; }
  let cfg; try{ cfg=JSON.parse(cfgText); }catch(e){ alert('JSON æ— æ•ˆï¼š'+e); return; }
  const s1=document.createElement('script'); s1.src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js";
  const s2=document.createElement('script'); s2.src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js";
  let loaded=0; const onload=()=>{
    if(++loaded===2){
      try{
        // é˜²æ­¢é‡å¤åˆå§‹åŒ–
        if(!window.firebase.apps.length){ window.firebase.initializeApp(cfg); }
        const db=window.firebase.database();
        db.ref('.info/connected').once('value').then(snap=>{
          const connected = !!snap.val();
          document.getElementById('statusBadge').textContent = connected ? 'åœ¨çº¿ï¼ˆå¯ç”¨ï¼‰' : 'åœ¨çº¿ï¼ˆæœªè¿æ¥åˆ°RTDBï¼‰';
          document.getElementById('statusBadge').className = 'badge ' + (connected ? 'bg-success' : 'bg-warning');
        }).catch(err=>{
          document.getElementById('statusBadge').textContent = 'è¿æ¥å¤±è´¥';
          document.getElementById('statusBadge').className = 'badge bg-danger';
        });
      }catch(e){
        document.getElementById('statusBadge').textContent = 'åˆå§‹åŒ–å¤±è´¥';
        document.getElementById('statusBadge').className = 'badge bg-danger';
      }
    }
  };
  s1.onload=onload; s2.onload=onload; document.head.appendChild(s1); document.head.appendChild(s2);
};

document.getElementById('buildBtn').onclick=buildLinks;
document.getElementById('clearBtn').onclick=()=>{
  document.getElementById('cfg').value='';
  document.getElementById('room').value='';
  document.getElementById('qid').value='';
  document.getElementById('teacherLink').value='';
  document.getElementById('studentLink').value='';
  const ctx1=document.getElementById('qrTeacher').getContext('2d'); ctx1.clearRect(0,0,256,256);
  const ctx2=document.getElementById('qrStudent').getContext('2d'); ctx2.clearRect(0,0,256,256);
  document.getElementById('statusBadge').textContent='æœªæ£€æµ‹'; document.getElementById('statusBadge').className='badge bg-secondary';
};
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
