<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ScanQuiz · 学生端</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<style>body{padding:16px}.card{border-radius:16px}</style>
</head>
<body class="bg-light">
<div class="container">
  <h4 class="mb-3">ScanQuiz · 学生端</h4>
  <div id="warn" class="alert alert-info">请稍等，正在加载题目…</div>
  <div class="card shadow-sm">
    <div class="card-body">
      <form id="form" class="d-none">
        <div class="row g-3 mb-3">
          <div class="col-6"><label class="form-label">姓名</label><input class="form-control" name="name" required></div>
          <div class="col-6"><label class="form-label">学号</label><input class="form-control" name="sid" required></div>
        </div>
        <div class="mb-2"><b id="topic"></b></div>
        <div class="mb-2" id="question"></div>
        <div id="opts"></div>
        <button class="btn btn-success mt-2" type="submit">提交</button>
      </form>
      <div id="feedback" class="mt-3"></div>
    </div>
  </div>
</div>

<script>
function params(){ const u=new URL(location.href); return {room:u.searchParams.get('room')||'', qid:u.searchParams.get('qid')||'', cfg:u.searchParams.get('cfg')||''}; }
const P=params(); let ONLINE=false, DB=null, Q=null;

function showWarn(msg, cls='alert-info'){ const w=document.getElementById('warn'); w.className='alert '+cls; w.textContent=msg; w.style.display='block'; }
function hideWarn(){ document.getElementById('warn').style.display='none'; }
function renderQuestion(q){
  Q=q;
  document.getElementById('topic').textContent = q.topic || '';
  document.getElementById('question').textContent = q.question || '';
  const box=document.getElementById('opts'); box.innerHTML='';
  ['A','B','C','D'].forEach(k=>{
    const text=q['option_'+k.toLowerCase()]||'';
    const id='opt'+k;
    box.insertAdjacentHTML('beforeend', `<div class="form-check">
      <input class="form-check-input" type="radio" name="ans" id="${id}" value="${k}" required>
      <label class="form-check-label" for="${id}">${k}. ${text}</label>
    </div>`);
  });
  document.getElementById('form').classList.remove('d-none');
}

function boot(){
  if(!ONLINE){ showWarn('未连接数据库', 'alert-danger'); return; }
  if(!P.room || !P.qid){ showWarn('链接缺少 room 或 qid 参数', 'alert-danger'); return; }
  const qref = DB.ref(`/rooms/${encodeURIComponent(P.room)}/${encodeURIComponent(P.qid)}/question`);
  qref.once('value').then(snap=>{
    const q=snap.val();
    if(!q){ showWarn('题目未发布或链接无效', 'alert-danger'); return; }
    hideWarn(); renderQuestion(q);
  }).catch(e=> showWarn('加载失败：'+e, 'alert-danger'));

  document.getElementById('form').onsubmit=(ev)=>{
    ev.preventDefault();
    const fd=new FormData(ev.target);
    const name=fd.get('name')||''; const sid=fd.get('sid')||''; const sel=fd.get('ans')||'';
    if(!name||!sid||!sel) return;
    const ts=Date.now();
    DB.ref(`/rooms/${encodeURIComponent(P.room)}/${encodeURIComponent(P.qid)}/responses/${ts}`).set({name,sid,sel,ts}).then(()=>{
      document.getElementById('feedback').innerHTML='<div class="alert alert-success">✅ 提交成功！</div>';
    }).catch(e=>{
      document.getElementById('feedback').innerHTML='<div class="alert alert-danger">提交失败：'+e+'</div>';
    });
  };
}

(function init(){
  // cfg 使用 base64(JSON) 传参，避免 URL 中的特殊字符问题
  if(!P.cfg){ showWarn('缺少 Firebase 配置。请从教师端生成二维码（自动附带 cfg）。', 'alert-warning'); return; }
  try{
    const cfg = JSON.parse(atob(P.cfg));
    const s1=document.createElement('script'); s1.src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js";
    const s2=document.createElement('script'); s2.src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js";
    let loaded=0; const onload=()=>{ if(++loaded===2){ firebase.initializeApp(cfg); DB=firebase.database(); ONLINE=true; boot(); } };
    s1.onload=onload; s2.onload=onload; document.head.appendChild(s1); document.head.appendChild(s2);
  }catch(e){ showWarn('配置解析失败：'+e, 'alert-danger'); }
})();
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
